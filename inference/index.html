<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Inference - seq2seq</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Inference";
    var mkdocs_page_input_path = "inference.md";
    var mkdocs_page_url = "/inference/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> seq2seq</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Overview</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../getting_started/">Getting Started</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../concepts/">Concepts</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../nmt/">Tutorial: Neural Machine Translation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../summarization/">Tutorial: Summarization</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../image_captioning/">Tutorial: Image Captioning</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../data/">Data</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../training/">Training</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Inference</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#inference-tasks">Inference Tasks</a></li>
                
            
                <li class="toctree-l3"><a href="#decodetext">DecodeText</a></li>
                
                    <li><a class="toctree-l4" href="#unk-token-replacement-using-a-copy-mechanism">UNK token replacement using a Copy Mechanism</a></li>
                
                    <li><a class="toctree-l4" href="#unk-token-replacement-using-a-mapping">UNK token replacement using a mapping</a></li>
                
            
                <li class="toctree-l3"><a href="#visualizing-attention">Visualizing Attention</a></li>
                
            
                <li class="toctree-l3"><a href="#dumping-beams">Dumping Beams</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../tools/">Tools</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../results/">Results</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../help/">Getting Help</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../contributing/">Contributing</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../license/">License</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../models/">Reference: Models</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../encoders/">Reference: Encoders</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../decoders/">Reference: Decoders</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">seq2seq</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Inference</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="inference-tasks">Inference Tasks</h2>
<p>When calling the inference script <code>bin/infer.py</code>, you must provide a list of tasks to run. The most basic task, <code>DecodeText</code>, simply prints out the model predictions. By additing more tasks you can perform additional features, such as storing debugging infromation or visualization attention scores. Under the hood, each <code>InferenceTask</code> is implemented as a Tensorflow <a href="https://www.tensorflow.org/api_docs/python/tf/train/SessionRunHook">SessionRunHook</a> that requests outputs from the model and knows how to process them.</p>
<h2 id="decodetext">DecodeText</h2>
<p>The <code>DecodeText</code> task reads the model predictions and prints the predictions to standard output. It has the following parameters:</p>
<ul>
<li><code>delimiter</code>: String to join the tokens predicted by the model on. Defaults to space.</li>
<li><code>unk_replace</code>: If set to <code>True</code>, perform unknown token replacement based on attention scores. Default is <code>False</code>. See below for more details.</li>
<li><code>unk_mapping</code>: If set to the path of a dictionary file, use the provided mapping to perform unknown token replacement. See below for more details.</li>
</ul>
<h4 id="unk-token-replacement-using-a-copy-mechanism">UNK token replacement using a Copy Mechanism</h4>
<p>Rare words (such as place and people names) are often absent from the target vocabulary and result in <code>UNK</code> tokens in the output predictions. An easy strategy to target sequences is to replace each <code>UNK</code> token with the word in the source sequence it is best aligned with. Alignments are typically calculated using an attention mechanism which produces alignment scores for each target token. If you trained a model that generates such attention scores (e.g. <code>AttentionSeq2Seq</code>), you can use them to perform UNK token replacement by activating the <code>unk_replace</code> parameter.</p>
<pre><code class="bash">mkdir -p ${DATA_PATH}/pred
python -m bin.infer \
  --tasks &quot;
    - class: DecodeText
      params:
        unk_replace: True&quot;
</code></pre>

<h4 id="unk-token-replacement-using-a-mapping">UNK token replacement using a mapping</h4>
<p>A more sophisticated approach to UNK token replacement is to use a mapping instead of copying words from the source. For example, the English word "Munich" is usually translated as "MÃ¼nchen" in German. Simply copying "Munich" from the source you would never result in the right translation even if the words were perfectly aligned using attention scores. One strategy is to use <a href="https://github.com/clab/fast_align">fast_align</a> to generate a mapping based on the conditional probabilities of target given source.</p>
<pre><code class="bash"># Download and build fast_align
git clone https://github.com/clab/fast_align.git
mkdir fast_align/build &amp;&amp; cd fast_align/build
cmake ../ &amp;&amp; make

# Convert your data into a format that fast_align understands:
# &lt;source&gt; ||| &lt;target&gt;
paste \
  $HOME/nmt_data/toy_reverse/train/sources.txt \
  $HOME/nmt_data/toy_reverse/train/targets.txt \
  | sed &quot;s/$(printf '\t')/ ||| /g&quot; &gt; $HOME/nmt_data/toy_reverse/train/source_targets.fastalign

# Learn alignments
./fast_align \
  -i $HOME/nmt_data/toy_reverse/train/source_targets.fastalign \
  -v -p $HOME/nmt_data/toy_reverse/train/source_targets.cond \
  &gt; $HOME/nmt_data/toy_reverse/train/source_targets.align

# Find the most probable traslation for each word and write them to a file
sort -k1,1 -k3,3gr $HOME/nmt_data/toy_reverse/train/source_targets.cond \
  | sort -k1,1 -u \
  &gt; $HOME/nmt_data/toy_reverse/train/source_targets.cond.dict

</code></pre>

<p>The output file specified by the <code>-p</code> argument will contain conditional probabilities for <code>p(target | source)</code> in the form of <code>&lt;source&gt;\t&lt;target&gt;\t&lt;prob&gt;</code>. These can be used to do smarter UNK token replacement by passing the <code>unk_mapping</code> flag.</p>
<pre><code class="bash">mkdir -p ${DATA_PATH}/pred
python -m bin.infer \
  --tasks &quot;
    - class: DecodeText
      params:
        unk_replace: True&quot;
        unk_mapping: $HOME/nmt_data/toy_reverse/train/source_targets.cond.dict&quot;
  ...
</code></pre>

<h2 id="visualizing-attention">Visualizing Attention</h2>
<p>If you trained a model using the  <code>AttentionDecoder</code>, you can dump the raw attention scores and generate alignment visualizations during inference using the <code>DumpAttention</code> task.</p>
<pre><code class="shell">python -m bin.infer \
  --tasks &quot;
    - class: DecodeText
    - class: DumpAttention
      params:
        output_dir: $HOME/attention&quot; \
  ...
</code></pre>

<p>By default, this script generates an <code>attention_score.npy</code> array file and one attention plot per example. The array file can be <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.load.html">loaded used numpy</a> and will contain a list of arrays with shape <code>[target_length, source_length]</code>. If you only want the raw attention score data without the plots you can enable the <code>dump_atention_no_plot</code> parameter.</p>
<h2 id="dumping-beams">Dumping Beams</h2>
<p>If you are using beam search during decoding, you can use the <code>DumpBeams</code> task to write beam search debugging information to disk. You can later inspect the data using numpy, or use the <a href="../tools/">provided script</a> to generate visualizations.</p>
<pre><code class="shell">python -m bin.infer \
  --tasks &quot;
    - class: DecodeText
    - class: DumpBeams
      params:
        file: ${TMPDIR:-/tmp}/wmt_16_en_de/newstest2014.pred.beams.npz&quot; \
  --model_params &quot;
    inference.beam_search.beam_width: 5&quot; \
  ...
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tools/" class="btn btn-neutral float-right" title="Tools">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../training/" class="btn btn-neutral" title="Training"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../training/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../tools/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
